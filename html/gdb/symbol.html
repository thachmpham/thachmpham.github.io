<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>Symbol Table</title>
  <style>
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    div.columns{display: flex; gap: min(4vw, 1.5em);}
    div.column{flex: auto; overflow-x: auto;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    /* The extra [class] is a hack that increases specificity enough to
       override a similar rule in reveal.js */
    ul.task-list[class]{list-style: none;}
    ul.task-list li input[type="checkbox"] {
      font-size: inherit;
      width: 0.8em;
      margin: 0 0.8em 0.2em -1.6em;
      vertical-align: middle;
    }
    /* CSS for syntax highlighting */
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
      }
    pre.numberSource { margin-left: 3em;  padding-left: 4px; }
    div.sourceCode
      { color: #cccccc; background-color: #303030; }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span.al { color: #ffcfaf; } /* Alert */
    code span.an { color: #7f9f7f; font-weight: bold; } /* Annotation */
    code span.at { } /* Attribute */
    code span.bn { color: #dca3a3; } /* BaseN */
    code span.bu { } /* BuiltIn */
    code span.cf { color: #f0dfaf; } /* ControlFlow */
    code span.ch { color: #dca3a3; } /* Char */
    code span.cn { color: #dca3a3; font-weight: bold; } /* Constant */
    code span.co { color: #7f9f7f; } /* Comment */
    code span.cv { color: #7f9f7f; font-weight: bold; } /* CommentVar */
    code span.do { color: #7f9f7f; } /* Documentation */
    code span.dt { color: #dfdfbf; } /* DataType */
    code span.dv { color: #dcdccc; } /* DecVal */
    code span.er { color: #c3bf9f; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #c0bed1; } /* Float */
    code span.fu { color: #efef8f; } /* Function */
    code span.im { } /* Import */
    code span.in { color: #7f9f7f; font-weight: bold; } /* Information */
    code span.kw { color: #f0dfaf; } /* Keyword */
    code span.op { color: #f0efd0; } /* Operator */
    code span.ot { color: #efef8f; } /* Other */
    code span.pp { color: #ffcfaf; font-weight: bold; } /* Preprocessor */
    code span.sc { color: #dca3a3; } /* SpecialChar */
    code span.ss { color: #cc9393; } /* SpecialString */
    code span.st { color: #cc9393; } /* String */
    code span.va { } /* Variable */
    code span.vs { color: #cc9393; } /* VerbatimString */
    code span.wa { color: #7f9f7f; font-weight: bold; } /* Warning */
  </style>
  <link rel="stylesheet" href="/html/style/dark.css" />
  <!-- <script src="../3pp/d3.v7.js"></script> -->
  <script type="module">
      import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.esm.min.mjs';
      mermaid.initialize({
          theme: 'dark',
      });
  </script>
</head>
<body>
<header id="title-block-header">
<h1 class="title">Symbol Table</h1>
</header>
<nav id="TOC" role="doc-toc">
<ul>
<li><a href="#symbol-table" id="toc-symbol-table">Symbol Table</a></li>
<li><a href="#static-symbol-table" id="toc-static-symbol-table">Static
Symbol Table</a>
<ul>
<li><a href="#section-header" id="toc-section-header">Section
Header</a></li>
<li><a href="#section-.strtab" id="toc-section-.strtab">Section
.strtab</a></li>
<li><a href="#section-.symtab" id="toc-section-.symtab">Section
.symtab</a></li>
</ul></li>
<li><a href="#dynamic-symbol-table"
id="toc-dynamic-symbol-table">Dynamic Symbol Table</a>
<ul>
<li><a href="#section-.dynsym" id="toc-section-.dynsym">Section
.dynsym</a></li>
<li><a href="#section-rela.plt" id="toc-section-rela.plt">Section
rela.plt</a></li>
<li><a href="#sections-.plt-and-.got"
id="toc-sections-.plt-and-.got">Sections .plt and .got</a>
<ul>
<li><a href="#runtime-linking" id="toc-runtime-linking">Runtime
Linking</a></li>
<li><a href="#before-first-call" id="toc-before-first-call">Before First
Call</a></li>
<li><a href="#after-first-call" id="toc-after-first-call">After First
Call</a></li>
</ul></li>
</ul></li>
<li><a href="#decode-symbol-table" id="toc-decode-symbol-table">Decode
Symbol Table</a>
<ul>
<li><a href="#struct-elf64_sym" id="toc-struct-elf64_sym">Struct
Elf64_Sym</a></li>
<li><a href="#decode-.symtab" id="toc-decode-.symtab">Decode
.symtab</a></li>
</ul></li>
<li><a href="#gdb" id="toc-gdb">GDB</a>
<ul>
<li><a href="#add-symbols" id="toc-add-symbols">Add Symbols</a></li>
<li><a href="#add-symbols-to-mmap-regions"
id="toc-add-symbols-to-mmap-regions">Add Symbols to mmap
Regions</a></li>
</ul></li>
<li><a href="#references" id="toc-references">References</a></li>
</ul>
</nav>
<h1 id="symbol-table">Symbol Table</h1>
<p>A symbol represents a function, a global variable, and other named
entity. The symbol table is a section that maps symbols to their
addresses. Two typical symbol tables are the .symtab and .dynsym
sections.</p>
<div class="columns">
<div class="column" style="width:50%;">
<p>The .symtab section.</p>
<ul>
<li>Contains all symbols in the file.</li>
<li>Used by the static linker at build time to resolve symbol references
between object files and perform relocations.</li>
<li>Can be stripped from the binary without affecting program
execution.</li>
</ul>
</div><div class="column" style="width:50%;">
<p>The .dynsym section.</p>
<ul>
<li>A subset of .symtab, contains only dynamic symbols.</li>
<li>Used by dynamic linker at runtime to resolve external references to
shared libraries.</li>
<li>Cannot be stripped from the binary because it is required for
program execution.</li>
</ul>
</div>
</div>
<p><br></p>
<h1 id="static-symbol-table">Static Symbol Table</h1>
<p>The .symtab section is associated with the section header and the
.strtab section.</p>
<ul>
<li>Section header: provides list of sections in the file. Each symbol
resides in one section.</li>
<li>.strtab (string table): provides symbol names for .symtab.</li>
</ul>
<p><br></p>
<p>Will examine the static symbol table of the below program.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> g_int <span class="op">=</span> <span class="bn">0xcafebabe</span><span class="op">;</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> sum<span class="op">(</span><span class="dt">int</span> x<span class="op">,</span> <span class="dt">int</span> y<span class="op">)</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> x <span class="op">+</span> y<span class="op">;</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">(</span><span class="dt">int</span> argc<span class="op">,</span> <span class="dt">char</span><span class="op">**</span> argv<span class="op">)</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> a <span class="op">=</span> <span class="dv">1</span><span class="op">,</span> b <span class="op">=</span> <span class="dv">2</span><span class="op">;</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> s <span class="op">=</span> sum<span class="op">(</span>a<span class="op">,</span> b<span class="op">);</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<div class="sourceCode" id="cb2"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> gcc main.c <span class="at">-o</span> main</span></code></pre></div>
<h2 id="section-header">Section Header</h2>
<p>The section header provides a list of sections and their details in
the ELF file.</p>
<div class="columns">
<div class="column" style="width:60%;">
<div class="sourceCode" id="cb3"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> readelf <span class="at">--wide</span> <span class="at">--sections</span> main</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="ex">Section</span> Headers:</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>  <span class="ex">[Nr]</span> Name              Type            Address          Off    Size   ES Flg Lk Inf Al</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>  <span class="ex">...</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>  <span class="bu">[</span> 6] .dynsym           DYNSYM          <span class="er">00000000000003d8</span> <span class="ex">0003d8</span> 000090 18   A  7   1  8</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>  <span class="bu">[</span> 7] .dynstr           STRTAB          <span class="er">0000000000000468</span> <span class="ex">000468</span> 000088 00   A  0   0  1</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>  <span class="ex">...</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>  <span class="ex">[12]</span> .plt              PROGBITS        0000000000001020 001020 000010 10  AX  0   0 16</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>  <span class="ex">[13]</span> .plt.got          PROGBITS        0000000000001030 001030 000010 10  AX  0   0 16</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>  <span class="ex">[14]</span> .text             PROGBITS        0000000000001040 001040 00013b 00  AX  0   0 16</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>  <span class="ex">...</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>  <span class="ex">[22]</span> .got              PROGBITS        0000000000003fc0 002fc0 000040 08  WA  0   0  8</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>  <span class="ex">[23]</span> .data             PROGBITS        0000000000004000 003000 000014 00  WA  0   0  8</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>  <span class="ex">[24]</span> .bss              NOBITS          0000000000004014 003014 000004 00  WA  0   0  1</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>  <span class="ex">...</span></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>  <span class="ex">[26]</span> .symtab           SYMTAB          0000000000000000 003048 000378 18     27  18  8</span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>  <span class="ex">[27]</span> .strtab           STRTAB          0000000000000000 0033c0 0001d3 00      0   0  1</span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>  <span class="ex">[28]</span> .shstrtab         STRTAB          0000000000000000 003593 00010c 00      0   0  1</span></code></pre></div>
</div><div class="column" style="width:40%;">
<p>Explain the output.</p>
<ul>
<li><p>There are 28 sections.</p></li>
<li><p>The .text section has index 14 (Nr). It contains the executable
machine code (PROBITS). In the file, it starts at offset 0x001040 and
has a size of 0x00013b bytes.</p></li>
<li><p>The index of .symtab is 26 (Nr). It is a symbol table (SYMTAB).
Within the file, it begins 0x003048 with a length of 0x000378
bytes.</p></li>
<li><p>The .strtab section, with index 27 (Nr), is a string table
(STRTAB). It starts at offset 0x0033c0 and spans 0x0001d3
bytes.</p></li>
</ul>
</div>
</div>
<h2 id="section-.strtab">Section .strtab</h2>
<p>The .strtab section is a string table that contains null-terminated
strings. Each string represents a symbol name.</p>
<div class="columns">
<div class="column" style="width:60%;">
<div class="sourceCode" id="cb4"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> readelf <span class="at">--string-dump</span><span class="op">=</span>.strtab main</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="ex">String</span> dump of section <span class="st">&#39;.strtab&#39;</span>:</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>  <span class="ex">...</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>  <span class="bu">[</span>   134]  g_int</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>  ...</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>  <span class="er">[</span>   <span class="er">163</span><span class="ex">]</span>  sum</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>  <span class="ex">...</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>  <span class="bu">[</span>   187]  main</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>  ...</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>  <span class="er">[</span>   <span class="er">1cd</span><span class="ex">]</span>  _init</span></code></pre></div>
</div><div class="column" style="width:40%;">
<p>Explain the output.</p>
<ul>
<li><p>Each line shows a symbol name and its offset within the .strtab
section.</p></li>
<li><p>The string g_init is located at offset 0x134.</p></li>
<li><p>The string sum is located at offset 0x163.</p></li>
<li><p>The string main is located at offset 0x187.</p></li>
</ul>
</div>
</div>
<h2 id="section-.symtab">Section .symtab</h2>
<p>The .symtab section contains all symbols in the file.</p>
<div class="columns">
<div class="column" style="width:60%;">
<div class="sourceCode" id="cb5"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;&gt;&gt;</span> readelf <span class="ex">--wide</span> <span class="at">--symbols</span> main</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="ex">Symbol</span> table <span class="st">&#39;.symtab&#39;</span> contains 37 entries:</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>   <span class="ex">Num:</span>    Value          Size Type    Bind   Vis      Ndx Name</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>    <span class="ex">...</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>    <span class="ex">23:</span> 0000000000004010     4 OBJECT  GLOBAL DEFAULT   23 g_int</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>    <span class="ex">...</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>    <span class="ex">27:</span> 0000000000001129    24 FUNC    GLOBAL DEFAULT   14 sum</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>    <span class="ex">...</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>    <span class="ex">32:</span> 0000000000001141    58 FUNC    GLOBAL DEFAULT   14 main</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>    <span class="ex">...</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>    <span class="ex">36:</span> 0000000000001000     0 FUNC    GLOBAL HIDDEN    11 _init</span></code></pre></div>
</div><div class="column" style="width:40%;">
<p>Explain the output.</p>
<ul>
<li><p>The g_int symbol represents a variable (OBJECT), with size of 4
bytes (Size). In the .data section (Ndx=23, section index), g_int
located at offset 0x4010 (Value).</p></li>
<li><p>The sum symbol is a function (FUNC). Within the .text section
(Ndx=14), sum located at 0x1129 (Value).</p></li>
<li><p>The main symbol is a function (FUNC). In .text (Ndx=14), main
located at 0x1141.</p></li>
</ul>
</div>
</div>
<h1 id="dynamic-symbol-table">Dynamic Symbol Table</h1>
<p>External symbol is a symbol whose address cannot be determined at
compile time, but must be resolved at runtime.</p>
<p>.dynsym is the section that contains the list of external symbols.
The .dynsym section works together with the .dynstr, .plt, .rela.plt,
.got sections.</p>
<ul>
<li>.dynstr (dynamic string): provides symbol names for .dynsym.</li>
<li>.plt (procedure linkage table): contains small executable code that
executes runtime linking.</li>
<li>.rela.plt (plt relocation table): tells the plt code how to resolve
external symbols addresses.</li>
<li>.got (global offset table): holds memory addresses of external
symbol addresses.</li>
</ul>
<p><br> Will examine the static symbol table of the below program.</p>
<p>Examine the .plt and .got.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">(</span><span class="dt">int</span> argc<span class="op">,</span> <span class="dt">char</span><span class="op">**</span> argv<span class="op">)</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>    puts<span class="op">(</span><span class="st">&quot;hello&quot;</span><span class="op">);</span>    </span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>Use ‘-fcf-protection=none’ to place puts@plt to .plt instead of
.plt.sec.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> gcc <span class="at">-fcf-protection</span><span class="op">=</span>none main.c <span class="at">-o</span> main</span></code></pre></div>
<h2 id="section-.dynsym">Section .dynsym</h2>
<p>The .dynsym section is a string table that contains null-terminated
strings. Each string represents a external symbol name.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> readelf <span class="at">--string-dump</span><span class="op">=</span>.dynstr main</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="ex">String</span> dump of section <span class="st">&#39;.dynstr&#39;</span>:</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>  <span class="ex">...</span>  </span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>  <span class="bu">[</span>    22]  puts</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>  ...</span></code></pre></div>
<h2 id="section-rela.plt">Section rela.plt</h2>
<p>rela.plt is a relocation table that tells the runtime linker how to
find addresses for external symbols.</p>
<div class="columns">
<div class="column" style="width:60%;">
<div class="sourceCode" id="cb9"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> readelf <span class="at">--relocs</span> main</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="ex">Relocation</span> section <span class="st">&#39;.rela.plt&#39;</span> at offset 0x600 contains 1 entry:</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>  <span class="ex">Offset</span>          Info           Type           Sym. Value    Sym. Name + Addend</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="ex">000000003fd0</span>  000300000007 R_X86_64_JUMP_SLO 0000000000000000 puts@GLIBC_2.2.5 + 0</span></code></pre></div>
</div><div class="column" style="width:40%;">
<p>Explain the output.</p>
<ul>
<li><p>R_X86_64_JUMP_SLOT: Writes the memory address of the external
symbol to the associated slot in .got. The slot size is 8
bytes.</p></li>
<li><p>Write the memory address of puts to .got at offset
0x3fd0.</p></li>
</ul>
</div>
</div>
<h2 id="sections-.plt-and-.got">Sections .plt and .got</h2>
<h3 id="runtime-linking">Runtime Linking</h3>
<p>The .plt section contains a small executable code to find addresses
for external symbols. The .got section holds the external symbol
addresses.</p>
<div class="sourceCode" id="cb10"><pre
class="sourceCode go"><code class="sourceCode go"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>                                            ┌──────────────────┐</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>┌──────────┐    ┌──────────────────────┐    │   ┌───────────┐  │   ┌─────────────────────────────┐    ┌──────────┐</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>│ main<span class="op">()</span>   │    │<span class="op">.</span>plt                  │    │   │<span class="op">.</span>got       │  │   │ runtime linker              │    │ rela<span class="op">.</span>plt │</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>│          │    <span class="op">|</span>──────────────────────<span class="op">|</span>    │   <span class="op">|</span>───────────<span class="op">|</span>  │   <span class="op">|</span>─────────────────────────────<span class="op">|</span>    │          │</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>│   puts<span class="op">()</span>─┼────┼► puts@plt<span class="op">()</span>          │    │   │           │  └───┼─►_dl_runtime_resolve<span class="op">()</span>      │    │          <span class="op">|</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>│          │    │    find puts in <span class="op">.</span>got─┼────┼──►│           │      │    find puts                │    │          │</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>│          │    │                      │    │   │           │      │    check rela<span class="op">.</span>plt ──────────┼──► │          <span class="op">|</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>└──────────┘    │    <span class="cf">if</span> not found      │    │   │           │◄─────┼─── update puts addr to <span class="op">.</span>got │    └──────────┘</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>                │       let linker find┼────┘   └───────────┘      └─────────────────────────────┘</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>                │    call puts         │</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>                └──────────────────────┘</span></code></pre></div>
<p>First call.</p>
<ul>
<li>When program calls puts, the call goes to puts@plt. Since the symbol
is not resolved yet, .plt delegates runtime linker to find the address
of puts in libc.so.</li>
<li>After found the address, it call puts.</li>
<li>Following the instructions in .rela.plt, the resolved address is
written to the corresponding entry in .got.</li>
</ul>
<p>Next calls.</p>
<ul>
<li>puts@put simply read the address of puts in .got and directly jump
to the function.</li>
</ul>
<p><br></p>
<p>Setup gdb to debug shared library events.</p>
<div class="sourceCode" id="cb11"><pre
class="sourceCode sh"><code class="sourceCode bash"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="kw">(</span><span class="fu">gdb</span><span class="kw">)</span> <span class="bu">set</span> stop-on-solib-events 1</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="kw">(</span><span class="fu">gdb</span><span class="kw">)</span> <span class="bu">set</span> auto-solib-add 0</span></code></pre></div>
<p>Start program.</p>
<div class="sourceCode" id="cb12"><pre
class="sourceCode sh"><code class="sourceCode bash"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="kw">(</span><span class="fu">gdb</span><span class="kw">)</span> <span class="bu">set</span> environment LD_LIBRARY_PATH .</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="kw">(</span><span class="fu">gdb</span><span class="kw">)</span> <span class="fu">file</span> main</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="kw">(</span><span class="fu">gdb</span><span class="kw">)</span> <span class="ex">start</span></span></code></pre></div>
<h3 id="before-first-call">Before First Call</h3>
<p>In the main function, when we call puts, it goes to puts@plt.</p>
<div class="sourceCode" id="cb13"><pre
class="sourceCode sh"><code class="sourceCode bash"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="kw">(</span><span class="fu">gdb</span><span class="kw">)</span> <span class="ex">disassemble</span> main</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="ex">Dump</span> of assembler code for function main:</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>   <span class="ex">0x0000555555555139</span> <span class="op">&lt;</span>+0<span class="op">&gt;</span>:     push   %rbp</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>   <span class="ex">0x000055555555513a</span> <span class="op">&lt;</span>+1<span class="op">&gt;</span>:     mov    %rsp,%rbp</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>   <span class="ex">0x000055555555513d</span> <span class="op">&lt;</span>+4<span class="op">&gt;</span>:     sub    <span class="va">$0</span>x10,%rsp</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>   <span class="ex">0x0000555555555141</span> <span class="op">&lt;</span>+8<span class="op">&gt;</span>:     mov    %edi,-0x4<span class="er">(</span><span class="ex">%rbp</span><span class="kw">)</span></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>   <span class="ex">0x0000555555555144</span> <span class="op">&lt;</span>+11<span class="op">&gt;</span>:    mov    %rsi,-0x10<span class="er">(</span><span class="ex">%rbp</span><span class="kw">)</span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>   <span class="ex">0x0000555555555148</span> <span class="op">&lt;</span>+15<span class="op">&gt;</span>:    lea    0xeb5<span class="er">(</span><span class="ex">%rip</span><span class="kw">)</span><span class="ex">,%rax</span>        <span class="co"># 0x555555556004</span></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>   <span class="ex">0x000055555555514f</span> <span class="op">&lt;</span>+22<span class="op">&gt;</span>:    mov    %rax,%rdi</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>   <span class="ex">0x0000555555555152</span> <span class="op">&lt;</span>+25<span class="op">&gt;</span>:    call   0x555555555030 <span class="op">&lt;</span>puts@plt<span class="op">&gt;</span></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>   <span class="ex">0x0000555555555157</span> <span class="op">&lt;</span>+30<span class="op">&gt;</span>:    mov    <span class="va">$0</span>x0,%eax</span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>   <span class="ex">0x000055555555515c</span> <span class="op">&lt;</span>+35<span class="op">&gt;</span>:    leave  </span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>   <span class="ex">0x000055555555515d</span> <span class="op">&lt;</span>+36<span class="op">&gt;</span>:    ret</span></code></pre></div>
<p>puts@plt jumps to 0x555555557fd0 that is the address of the
associated entry in .got.</p>
<div class="sourceCode" id="cb14"><pre
class="sourceCode sh"><code class="sourceCode bash"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="kw">(</span><span class="fu">gdb</span><span class="kw">)</span> <span class="ex">disassemble</span> 0x555555555030</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="ex">Dump</span> of assembler code for function puts@plt:</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>   <span class="ex">0x0000555555555030</span> <span class="op">&lt;</span>+0<span class="op">&gt;</span>:     jmp    <span class="pp">*</span>0x2f9a<span class="er">(</span><span class="ex">%rip</span><span class="kw">)</span>        <span class="co"># 0x555555557fd0 &lt;puts@got.plt&gt;</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>   <span class="ex">0x0000555555555036</span> <span class="op">&lt;</span>+6<span class="op">&gt;</span>:     push   <span class="va">$0</span>x0</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>   <span class="ex">0x000055555555503b</span> <span class="op">&lt;</span>+11<span class="op">&gt;</span>:    jmp    0x555555555020</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a><span class="kw">(</span><span class="fu">gdb</span><span class="kw">)</span> <span class="ex">info</span> symbol 0x555555557fd0</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a><span class="ex">puts@got[plt]</span> in section .got of /root/demo/main</span></code></pre></div>
<p>Since the address of puts is not yet resolved, the corresponding .got
entry points back to 0x1036, an instruction in .plt, as shown in the
objdump output. This indicates that the symbol has not been resolved, so
the runtime linker is delegated to find the address.</p>
<div class="sourceCode" id="cb15"><pre
class="sourceCode sh"><code class="sourceCode bash"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="kw">(</span><span class="fu">gdb</span><span class="kw">)</span> <span class="ex">x/a</span> 0x555555557fd0</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="ex">0x555555557fd0</span> <span class="op">&lt;</span>puts@got.plt<span class="op">&gt;</span>:  0x1036</span></code></pre></div>
<div class="sourceCode" id="cb16"><pre
class="sourceCode sh"><code class="sourceCode bash"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> objdump <span class="at">--disassemble</span> <span class="at">--section</span><span class="op">=</span>.plt main</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="ex">0000000000001030</span> <span class="op">&lt;</span>puts@plt<span class="op">&gt;</span>:</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>    <span class="ex">1030:</span>       ff 25 9a 2f 00 00       jmp    <span class="pp">*</span>0x2f9a<span class="er">(</span><span class="ex">%rip</span><span class="kw">)</span>        <span class="co"># 3fd0 &lt;puts@GLIBC_2.2.5&gt;</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>    <span class="ex">1036:</span>       68 00 00 00 00          push   <span class="va">$0</span>x0</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>    <span class="ex">103b:</span>       e9 e0 ff ff ff          jmp    1020 <span class="op">&lt;</span>_init+0x20<span class="op">&gt;</span></span></code></pre></div>
<p>Illustrate the call flow.</p>
<div class="sourceCode" id="cb17"><pre
class="sourceCode go"><code class="sourceCode go"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>                 file<span class="op">:</span> main                                    file<span class="op">:</span> main              </span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>              section<span class="op">:</span> <span class="op">.</span>plt                                 section<span class="op">:</span> <span class="op">.</span>got            </span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>             function<span class="op">:</span> puts@plt<span class="op">()</span>                                                    </span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>┌────────────────────┬─────────────────────┐      ┌────────────────┬────────────────┐</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>│ address            │ value               │      │ address        │     value      │</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>┼────────────────────┼─────────────────────┤      ┼────────────────┼────────────────┤ </span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>│ <span class="bn">0x0000555555555030</span> │ jump  <span class="bn">0x555555557fd0</span>┼───┐  │                │                │ </span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>│                    │                     │   │  │                │                │</span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>│ <span class="bn">0x0000555555555036</span> │ push  $<span class="bn">0x0</span>  ◄───────┼─┐ └──┼►<span class="bn">0x555555557fd0</span> │ <span class="bn">0x1036</span> ──┐     │</span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>│                    │                     │ │    │                │          │     │</span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>│ <span class="bn">0x000055555555503b</span> │ jmp   <span class="bn">0x555555555020</span>│ └────┼────────────────┼──────────┘     │</span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>└────────────────────┴─────────────────────┘      └────────────────┴────────────────┘ </span></code></pre></div>
<p>Examine .got.</p>
<div class="sourceCode" id="cb18"><pre
class="sourceCode sh"><code class="sourceCode bash"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="kw">(</span><span class="fu">gdb</span><span class="kw">)</span> <span class="ex">info</span> files</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="ex">0x0000555555557fb8</span> <span class="at">-</span> 0x0000555555558000 is .got</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a><span class="kw">(</span><span class="fu">gdb</span><span class="kw">)</span> <span class="ex">x/9a</span> 0x0000555555557fb8</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a><span class="ex">0x555555557fb8:</span> 0x3dc8  0x0</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a><span class="ex">0x555555557fc8:</span> 0x0     0x1036</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a><span class="ex">0x555555557fd8:</span> 0x0     0x0</span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a><span class="ex">0x555555557fe8:</span> 0x0     0x0</span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a><span class="ex">0x555555557ff8:</span> 0x0</span></code></pre></div>
<h3 id="after-first-call">After First Call</h3>
<p>Continue program, it will stop when libc.so loaded.</p>
<div class="sourceCode" id="cb19"><pre
class="sourceCode sh"><code class="sourceCode bash"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="kw">(</span><span class="fu">gdb</span><span class="kw">)</span> <span class="cf">continue</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="ex">Stopped</span> due to shared library event:</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>  <span class="ex">Inferior</span> loaded /lib/x86_64-linux-gnu/libc.so.6</span></code></pre></div>
<p>Examine .got. After runtime loader solve puts, it updated the .got
entry from 0x1036 to 0x7ffff7e08e50, which is the memory address of puts
in libc.so.</p>
<div class="sourceCode" id="cb20"><pre
class="sourceCode sh"><code class="sourceCode bash"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="kw">(</span><span class="fu">gdb</span><span class="kw">)</span> <span class="ex">x/9a</span> 0x0000555555557fb8</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="ex">0x555555557fb8:</span> 0x3dc8  0x0</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a><span class="ex">0x555555557fc8:</span> 0x0     0x7ffff7e08e50 <span class="op">&lt;</span>__GI__IO_puts<span class="op">&gt;</span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a><span class="ex">0x555555557fd8:</span> 0x7ffff7db1dc0 <span class="op">&lt;</span>__libc_start_main_impl<span class="op">&gt;</span> 0x0</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a><span class="ex">0x555555557fe8:</span> 0x0     0x0</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a><span class="ex">0x555555557ff8:</span> 0x7ffff7dcd9a0 <span class="op">&lt;</span>__cxa_finalize<span class="op">&gt;</span></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a><span class="kw">(</span><span class="fu">gdb</span><span class="kw">)</span> <span class="ex">info</span> symbol 0x7ffff7e08e50</span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a><span class="ex">puts</span> in section .text of /lib/x86_64-linux-gnu/libc.so.6</span></code></pre></div>
<p>Check the call flow of puts@plt. Now, it jumps directly to
0x7ffff7e08e50, the memory address of puts in libc.so.</p>
<div class="sourceCode" id="cb21"><pre
class="sourceCode sh"><code class="sourceCode bash"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="kw">(</span><span class="fu">gdb</span><span class="kw">)</span> <span class="ex">disassemble</span> 0x555555555030</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="ex">Dump</span> of assembler code for function puts@plt:</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>   <span class="ex">0x0000555555555030</span> <span class="op">&lt;</span>+0<span class="op">&gt;</span>:     jmp    <span class="pp">*</span>0x2f9a<span class="er">(</span><span class="ex">%rip</span><span class="kw">)</span>        <span class="co"># 0x555555557fd0 &lt;puts@got.plt&gt;</span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>   <span class="ex">0x0000555555555036</span> <span class="op">&lt;</span>+6<span class="op">&gt;</span>:     push   <span class="va">$0</span>x0</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>   <span class="ex">0x000055555555503b</span> <span class="op">&lt;</span>+11<span class="op">&gt;</span>:    jmp    0x555555555020</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a><span class="kw">(</span><span class="fu">gdb</span><span class="kw">)</span> <span class="ex">x/a</span> 0x555555557fd0</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a><span class="ex">0x555555557fd0</span> <span class="op">&lt;</span>puts@got.plt<span class="op">&gt;</span>:  0x7ffff7e08e50 <span class="op">&lt;</span>__GI__IO_puts<span class="op">&gt;</span></span></code></pre></div>
<p>Illustrate the call flow.</p>
<div class="sourceCode" id="cb22"><pre
class="sourceCode go"><code class="sourceCode go"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>                 file<span class="op">:</span> main                                    file<span class="op">:</span> main                              file<span class="op">:</span> libc<span class="op">.</span>so</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>              section<span class="op">:</span> <span class="op">.</span>plt                                 section<span class="op">:</span> <span class="op">.</span>got                           section<span class="op">:</span> <span class="op">.</span>text</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>             function<span class="op">:</span> puts@plt<span class="op">()</span>                                                                   function<span class="op">:</span> puts</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>┌────────────────────┬─────────────────────┐      ┌────────────────┬────────────────┐      ┌────────────────┬────────────────┐</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>│ address            │ value               │      │ address        │     value      │      │ address        │     value      │</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>┼────────────────────┼─────────────────────┤      ┼────────────────┼────────────────┤      ┼────────────────┼────────────────┤</span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>│ <span class="bn">0x0000555555555030</span> │ jump  <span class="bn">0x555555557fd0</span>┼───┐  │                │                │  ┌───┼►<span class="bn">0x7ffff7e08e50</span> │ endbr64        │</span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>│                    │                     │   │  │                │                │  │   │                │                │</span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>│ <span class="bn">0x0000555555555036</span> │ push  $<span class="bn">0x0</span>          │   └──┼►<span class="bn">0x555555557fd0</span> │ <span class="bn">0x7ffff7e08e50</span>─┼──┘   │ <span class="bn">0x7ffff7e08e54</span> │ push   <span class="op">%</span>r14    │</span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>│                    │                     │      │                │                │      │                │                │</span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a>│ <span class="bn">0x000055555555503b</span> │ jmp   <span class="bn">0x555555555020</span>│      │                │                │      │ <span class="bn">0x7ffff7e08e56</span> │ push   <span class="op">%</span>r13    │</span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a>└────────────────────┴─────────────────────┘      └────────────────┴────────────────┘      └────────────────┴────────────────┘</span></code></pre></div>
<h1 id="decode-symbol-table">Decode Symbol Table</h1>
<h2 id="struct-elf64_sym">Struct Elf64_Sym</h2>
<div class="columns">
<div class="column" style="width:50%;">
<p>The entry in symbol table is represented by the Elf64_Sym struct in
x86_64 or Elf32_Sym struct in x86.</p>
<div class="sourceCode" id="cb23"><pre
class="sourceCode sh"><code class="sourceCode bash"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> pahole elf64_sym</span></code></pre></div>
<div class="sourceCode" id="cb24"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> elf64_sym <span class="op">{</span>          <span class="co">// offset size</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>  Elf64_Word      st_name<span class="op">;</span>  <span class="co">// 0      4</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">unsigned</span> <span class="dt">char</span>   st_info<span class="op">;</span>  <span class="co">// 4      1</span></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">unsigned</span> <span class="dt">char</span>   st_other<span class="op">;</span> <span class="co">// 5      1</span></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>  Elf64_Half      st_shndx<span class="op">;</span> <span class="co">// 6      2</span></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>  Elf64_Addr      st_value<span class="op">;</span> <span class="co">// 8      8</span></span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>  Elf64_Xword     st_size<span class="op">;</span>  <span class="co">// 16     8</span></span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>  <span class="co">/* size: 24 bytes */</span></span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span></code></pre></div>
</div><div class="column" style="width:50%;">
<p>Relationships to other sections.</p>
<ul>
<li>Field st_index represents the symbol name, which points to index of
an entry in the string table .strtab.</li>
<li>Field st_shndx represents the section that , which points to index
of an entry in the section header table.</li>
</ul>
<div class="sourceCode" id="cb25"><pre
class="sourceCode go"><code class="sourceCode go"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>┌────────────┐       ┌────────────┐        ┌────────────┐</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>│   <span class="op">.</span>strtab  │       │  <span class="op">.</span>symtab   │        │  section   <span class="op">|</span></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>┼────────────┤       ┼────────────┤        ┼────────────┤</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>│   index ◄──┼───────┼─ st_index  │   ┌────┼► index     │</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>│            │       │            │   │    │            │</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>│   value    │       │  st_shndx ─┼───┘    │  <span class="op">.....</span>     │</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>└────────────┘       └────────────┘        └────────────┘</span></code></pre></div>
</div>
</div>
<p>To decode struct elf64_sym from raw hex memory, we use python script
hex_to_elf64_sym.py.</p>
<div class="sourceCode" id="cb26"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> struct</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> sys</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>FMT_ELF64_SYM <span class="op">=</span> <span class="st">&quot;=IBBHQQ&quot;</span></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> hex_to_elf64_sym(hex_str: <span class="bu">str</span>):</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>    data <span class="op">=</span> <span class="bu">bytes</span>.fromhex(hex_str)</span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>    name, info, other, shndx, value, size <span class="op">=</span> struct.unpack(FMT_ELF64_SYM, data)</span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;name info other shndx value size&quot;</span>)</span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="bu">hex</span>(name), <span class="bu">hex</span>(info), <span class="bu">hex</span>(other),</span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a>            <span class="bu">hex</span>(shndx), <span class="bu">hex</span>(value), <span class="bu">hex</span>(size))</span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a>hex_to_elf64_sym(sys.argv[<span class="dv">1</span>])</span></code></pre></div>
<h2 id="decode-.symtab">Decode .symtab</h2>
<p>We will extract and decode .symtab of the below program.</p>
<div class="columns">
<div class="column" style="width:40%;">
<p>File main.c</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> g_int <span class="op">=</span> <span class="bn">0xcafebabe</span><span class="op">;</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> sum<span class="op">(</span><span class="dt">int</span> x<span class="op">,</span> <span class="dt">int</span> y<span class="op">)</span></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> x <span class="op">+</span> y<span class="op">;</span></span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">(</span><span class="dt">int</span> argc<span class="op">,</span> <span class="dt">char</span><span class="op">**</span> argv<span class="op">)</span></span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> a <span class="op">=</span> <span class="dv">1</span><span class="op">,</span> b <span class="op">=</span> <span class="dv">2</span><span class="op">;</span></span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> s <span class="op">=</span> sum<span class="op">(</span>a<span class="op">,</span> b<span class="op">);</span></span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<div class="sourceCode" id="cb28"><pre
class="sourceCode sh"><code class="sourceCode bash"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> gcc main.c <span class="at">-o</span> main</span></code></pre></div>
</div><div class="column" style="width:60%;">
<p>List sections.</p>
<div class="sourceCode" id="cb29"><pre
class="sourceCode sh"><code class="sourceCode bash"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> readelf <span class="at">--section-headers</span> main</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a><span class="ex">[Nr]</span> Name       Type        Address          Off    Size   ES Flg Lk Inf Al</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a><span class="ex">[14]</span> .text      PROGBITS    0000000000001040 001040 00013b 00  AX  0   0 16</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a><span class="ex">[23]</span> .data      PROGBITS    0000000000004000 003000 000014 00  WA  0   0  8</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a><span class="ex">[26]</span> .symtab    SYMTAB      0000000000000000 003048 000378 18     27  18  8</span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a><span class="ex">[27]</span> .strtab    STRTAB      0000000000000000 0033c0 0001d3 00      0   0  1</span></code></pre></div>
<p>Print string table .strtab.</p>
<div class="sourceCode" id="cb30"><pre
class="sourceCode sh"><code class="sourceCode bash"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> readelf <span class="at">--string-dump</span><span class="op">=</span>.strtab main</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a><span class="bu">[</span>   134]  g_int</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>[   163]  <span class="er">sum</span></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a><span class="bu">[</span>   187]  main</span></code></pre></div>
</div>
</div>
<div class="columns">
<div class="column" style="width:50%;">
<p>Extract section .symtab, which starts at offset 0x003048, size of
0x000378. The elf64_sym struct has a size of 24 bytes, so use option
‘xxd -c 24’ to display 24 bytes each line.</p>
<div class="sourceCode" id="cb31"><pre
class="sourceCode sh"><code class="sourceCode bash"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> xxd <span class="at">-p</span> <span class="at">-g</span> 1 <span class="at">-c</span> 24 <span class="at">-s</span> 0x003048 <span class="at">-l</span> 0x000378 main</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a><span class="ex">340100001100170010400000000000000400000000000000</span></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a><span class="ex">6301000012000e0029110000000000001800000000000000</span></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a><span class="ex">8701000012000e0041110000000000003a00000000000000</span></span></code></pre></div>
<p>Decode the first line.</p>
<div class="sourceCode" id="cb32"><pre
class="sourceCode sh"><code class="sourceCode bash"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> hex_to_elf64_sym.py 340100001100170010400000000000000400000000000000</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>  <span class="ex">name</span>     info    other  shndx   value     size</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a><span class="ex">[</span><span class="st">&#39;0x134&#39;</span><span class="ex">,</span> <span class="st">&#39;0x11&#39;</span>, <span class="st">&#39;0x0&#39;</span>, <span class="st">&#39;0x17&#39;</span>, <span class="st">&#39;0x4010&#39;</span>, <span class="st">&#39;0x4&#39;</span>]</span></code></pre></div>
<p>Decode the second line.</p>
<div class="sourceCode" id="cb33"><pre
class="sourceCode sh"><code class="sourceCode bash"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> hex_to_elf64_sym.py 6301000012000e0029110000000000001800000000000000</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>  <span class="ex">name</span>     info    other  shndx  value     size</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a><span class="ex">[</span><span class="st">&#39;0x163&#39;</span><span class="ex">,</span> <span class="st">&#39;0x12&#39;</span>, <span class="st">&#39;0x0&#39;</span>, <span class="st">&#39;0xe&#39;</span>, <span class="st">&#39;0x1129&#39;</span>, <span class="st">&#39;0x18&#39;</span>]</span></code></pre></div>
</div><div class="column" style="width:50%;">
<p>Explain the outputs.</p>
<table>
<thead>
<tr class="header">
<th style="text-align: left;">First Line</th>
<th style="text-align: left;"></th>
<th style="text-align: left;"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">st_name</td>
<td style="text-align: left;">0x134</td>
<td style="text-align: left;">Index 0x134 in .strtab: g_int</td>
</tr>
<tr class="even">
<td style="text-align: left;">st_info</td>
<td style="text-align: left;">0x11</td>
<td style="text-align: left;">Type object, global</td>
</tr>
<tr class="odd">
<td style="text-align: left;">st_other</td>
<td style="text-align: left;">0x0</td>
<td style="text-align: left;">Visibility default</td>
</tr>
<tr class="even">
<td style="text-align: left;">st_shndx</td>
<td style="text-align: left;">0x17</td>
<td style="text-align: left;">Section 0x17 = 23 = .data</td>
</tr>
<tr class="odd">
<td style="text-align: left;">st_value</td>
<td style="text-align: left;">0x4010</td>
<td style="text-align: left;">Offset 0x4010</td>
</tr>
<tr class="even">
<td style="text-align: left;">st_size</td>
<td style="text-align: left;">0x4</td>
<td style="text-align: left;">Size of 4 bytes</td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr class="header">
<th style="text-align: left;">Second Line</th>
<th style="text-align: left;"></th>
<th style="text-align: left;"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">st_name</td>
<td style="text-align: left;">0x163</td>
<td style="text-align: left;">Index 0x136 in .strtab: sum</td>
</tr>
<tr class="even">
<td style="text-align: left;">st_info</td>
<td style="text-align: left;">0x11</td>
<td style="text-align: left;">Type func, global</td>
</tr>
<tr class="odd">
<td style="text-align: left;">st_other</td>
<td style="text-align: left;">0x0</td>
<td style="text-align: left;">Visibility default</td>
</tr>
<tr class="even">
<td style="text-align: left;">st_shndx</td>
<td style="text-align: left;">0x17</td>
<td style="text-align: left;">Section: 0xe = 14 = .text</td>
</tr>
<tr class="odd">
<td style="text-align: left;">st_value</td>
<td style="text-align: left;">0x4010</td>
<td style="text-align: left;">Offset 0x1129</td>
</tr>
<tr class="even">
<td style="text-align: left;">st_size</td>
<td style="text-align: left;">0x18</td>
<td style="text-align: left;">Size of 24 bytes</td>
</tr>
</tbody>
</table>
</div>
</div>
<h1 id="gdb">GDB</h1>
<h2 id="add-symbols">Add Symbols</h2>
<div class="columns">
<div class="column" style="width:50%;">
<p>GDB supports adding symbol table from file, it is useful when
debugging code loaded by mmap.</p>
<p>To add the symbols.</p>
<div class="sourceCode" id="cb34"><pre
class="sourceCode sh"><code class="sourceCode bash"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>  <span class="ex">add-symbol-file</span> filename</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>    <span class="ex">[-readnow</span><span class="kw">|</span><span class="ex">-readnever]</span></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>    <span class="ex">[-o</span> offset]</span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>    <span class="ex">[textaddr]</span></span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>    <span class="ex">[-s</span> section addr…]</span></code></pre></div>
<p>To remove symbols.</p>
<div class="sourceCode" id="cb35"><pre
class="sourceCode sh"><code class="sourceCode bash"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>  <span class="ex">remove-symbol-file</span> filename</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>  <span class="ex">remove-symbol-file</span> <span class="at">-a</span> addr</span></code></pre></div>
</div><div class="column" style="width:50%;">
<p>Parameters:</p>
<ul>
<li><em>filename</em>: the file contains the symbol table.</li>
</ul>
<p>For .text section.</p>
<ul>
<li><em>textaddr</em>: the memory address where .text of the file is
loaded. It is required for debugging functions within .text.</li>
</ul>
<p>For other sections, such as: .bss, .data,…</p>
<ul>
<li><em>section</em>: section name.</li>
<li><em>addr</em>: memory address where the section is loaded.</li>
</ul>
<p>Other options.</p>
<ul>
<li><em>readnow</em>: load symbols immediately.</li>
<li><em>readnever</em>: not load symbol.</li>
<li><em>offset</em>: offset to add to the start address of each section,
except sections specified addresses explicitly.</li>
</ul>
</div>
</div>
<h2 id="add-symbols-to-mmap-regions">Add Symbols to mmap Regions</h2>
<p>In the below example, we will add symbols for memory regions that is
loaded by mmap.</p>
<div class="columns">
<div class="column" style="width:60%;">
<p>File main.c</p>
<div class="sourceCode" id="cb36"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;sys/mman.h&gt;</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stddef.h&gt;</span></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;fcntl.h&gt;</span></span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">()</span></span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> fd <span class="op">=</span> open<span class="op">(</span><span class="st">&quot;math.o&quot;</span><span class="op">,</span> O_RDONLY<span class="op">);</span></span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">// load math.o to memory</span></span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a>    mmap<span class="op">(</span></span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true" tabindex="-1"></a>        NULL<span class="op">,</span> <span class="co">// let kernel choose start addr of region</span></span>
<span id="cb36-12"><a href="#cb36-12" aria-hidden="true" tabindex="-1"></a>        <span class="dv">4096</span><span class="op">,</span> <span class="co">// length of the region</span></span>
<span id="cb36-13"><a href="#cb36-13" aria-hidden="true" tabindex="-1"></a>        PROT_READ<span class="op">|</span>PROT_EXEC<span class="op">,</span> <span class="co">// protection mode</span></span>
<span id="cb36-14"><a href="#cb36-14" aria-hidden="true" tabindex="-1"></a>        MAP_PRIVATE<span class="op">,</span>         <span class="co">// visible mode</span></span>
<span id="cb36-15"><a href="#cb36-15" aria-hidden="true" tabindex="-1"></a>        fd<span class="op">,</span>                  <span class="co">// file to load</span></span>
<span id="cb36-16"><a href="#cb36-16" aria-hidden="true" tabindex="-1"></a>        <span class="dv">0</span>                    <span class="co">// offset in file</span></span>
<span id="cb36-17"><a href="#cb36-17" aria-hidden="true" tabindex="-1"></a>    <span class="op">);</span></span>
<span id="cb36-18"><a href="#cb36-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-19"><a href="#cb36-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb36-20"><a href="#cb36-20" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
</div><div class="column" style="width:40%;">
<p>File math.c</p>
<div class="sourceCode" id="cb37"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> number1 <span class="op">=</span> <span class="bn">0xCAFEBABE</span><span class="op">;</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> number2 <span class="op">=</span> <span class="bn">0xC1A0C1A0</span><span class="op">;</span></span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> sum<span class="op">(</span><span class="dt">int</span> x<span class="op">,</span> <span class="dt">int</span> y<span class="op">)</span></span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> x <span class="op">+</span> y<span class="op">;</span></span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> sub<span class="op">(</span><span class="dt">int</span> x<span class="op">,</span> <span class="dt">int</span> y<span class="op">)</span></span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> x <span class="op">-</span> y<span class="op">;</span></span>
<span id="cb37-12"><a href="#cb37-12" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>Build.</p>
<div class="sourceCode" id="cb38"><pre
class="sourceCode sh"><code class="sourceCode bash"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> gcc <span class="at">-c</span> math.c <span class="at">-o</span> math.o</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> gcc <span class="at">-g</span> main.c <span class="at">-o</span> main</span></code></pre></div>
</div>
</div>
<div class="columns">
<div class="column" style="width:60%;">
<p>Sections in math.o.</p>
<div class="sourceCode" id="cb39"><pre
class="sourceCode sh"><code class="sourceCode bash"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> readelf <span class="at">--section-headers</span> <span class="at">--wide</span> math.o</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a><span class="ex">[Nr]</span> Name     Type        Address          Off    Size   ES Flg Lk Inf Al</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a><span class="bu">[</span> 1] .text    PROGBITS    <span class="er">0000000000000000</span> <span class="ex">000040</span> 00002e 00  AX  0   0  1</span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a><span class="bu">[</span> 2] .data    PROGBITS    <span class="er">0000000000000000</span> <span class="ex">000070</span> 000008 00  WA  0   0  4</span></code></pre></div>
<p>Symbols in math.o.</p>
<div class="sourceCode" id="cb40"><pre
class="sourceCode sh"><code class="sourceCode bash"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> readelf <span class="at">--symbols</span> math.o</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a><span class="ex">Num:</span>    Value          Size Type    Bind   Vis      Ndx Name</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>  <span class="ex">3:</span> 0000000000000000     4 OBJECT  GLOBAL DEFAULT    2 number1</span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>  <span class="ex">4:</span> 0000000000000004     4 OBJECT  GLOBAL DEFAULT    2 number2</span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>  <span class="ex">5:</span> 0000000000000000    24 FUNC    GLOBAL DEFAULT    1 sum</span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a>  <span class="ex">6:</span> 0000000000000018    22 FUNC    GLOBAL DEFAULT    1 sub</span></code></pre></div>
<ul>
<li>Section .text locates at offset 0x40.</li>
<li>Section .data locates at offset 0x70.</li>
<li>Within .text, symbols sum, sub locates at offsets 0x00, 0x18.</li>
<li>Within .data, symbols number1, number2 locates offsets 0x00,
0x14.</li>
</ul>
</div><div class="column" style="width:40%;">
<p>Illustrate math.o.</p>
<div class="sourceCode" id="cb41"><pre
class="sourceCode go"><code class="sourceCode go"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="op">+---------------------+</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a><span class="op">|</span> ELF File Header     <span class="op">|</span> <span class="bn">0x00</span></span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a><span class="op">+---------------------+</span></span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a><span class="op">|</span> Program Headers     <span class="op">|</span></span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a><span class="op">+---------------------+</span></span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a><span class="op">|</span> <span class="op">.</span>text Section       <span class="op">|</span> <span class="bn">0x40</span></span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a><span class="op">|</span> ├── sum<span class="op">()</span>           <span class="op">|</span>      <span class="op">+</span> <span class="bn">0x00</span></span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a><span class="op">|</span> └── sub<span class="op">()</span>           <span class="op">|</span>      <span class="op">+</span> <span class="bn">0x18</span></span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a><span class="op">|</span>                     <span class="op">|</span></span>
<span id="cb41-10"><a href="#cb41-10" aria-hidden="true" tabindex="-1"></a><span class="op">+---------------------+</span></span>
<span id="cb41-11"><a href="#cb41-11" aria-hidden="true" tabindex="-1"></a><span class="op">|</span> <span class="op">.</span>data Section       <span class="op">|</span> <span class="bn">0x70</span></span>
<span id="cb41-12"><a href="#cb41-12" aria-hidden="true" tabindex="-1"></a><span class="op">|</span> ├── number1         <span class="op">|</span>      <span class="op">+</span> <span class="bn">0x00</span></span>
<span id="cb41-13"><a href="#cb41-13" aria-hidden="true" tabindex="-1"></a><span class="op">|</span> └── number2         <span class="op">|</span>      <span class="op">+</span> <span class="bn">0x04</span></span>
<span id="cb41-14"><a href="#cb41-14" aria-hidden="true" tabindex="-1"></a><span class="op">|</span>                     <span class="op">|</span></span>
<span id="cb41-15"><a href="#cb41-15" aria-hidden="true" tabindex="-1"></a><span class="op">+---------------------+</span></span>
<span id="cb41-16"><a href="#cb41-16" aria-hidden="true" tabindex="-1"></a><span class="op">|</span> Other Sections<span class="op">...</span>   <span class="op">|</span></span>
<span id="cb41-17"><a href="#cb41-17" aria-hidden="true" tabindex="-1"></a><span class="op">+---------------------+</span></span>
<span id="cb41-18"><a href="#cb41-18" aria-hidden="true" tabindex="-1"></a><span class="op">|</span> Section Headers     <span class="op">|</span></span>
<span id="cb41-19"><a href="#cb41-19" aria-hidden="true" tabindex="-1"></a><span class="op">+---------------------+</span></span></code></pre></div>
</div>
</div>
<div class="columns">
<div class="column" style="width:60%;">
<p>Start program.</p>
<div class="sourceCode" id="cb42"><pre
class="sourceCode sh"><code class="sourceCode bash"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="kw">(</span><span class="fu">gdb</span><span class="kw">)</span> <span class="fu">file</span> main</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a><span class="kw">(</span><span class="fu">gdb</span><span class="kw">)</span> <span class="cf">break</span> <span class="ex">main.c:19</span></span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a><span class="kw">(</span><span class="fu">gdb</span><span class="kw">)</span> <span class="ex">run</span></span></code></pre></div>
<p>Print memory mappings.</p>
<div class="sourceCode" id="cb43"><pre
class="sourceCode sh"><code class="sourceCode bash"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="kw">(</span><span class="fu">gdb</span><span class="kw">)</span> <span class="ex">info</span> proc mappings</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>    <span class="ex">Start</span> Addr         End Addr   Size     Offset  Perms  objfile</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a><span class="ex">0x7ffff7ffa000</span>   0x7ffff7ffb000   0x1000   0x0     r-xp   math.o</span></code></pre></div>
<p>When math.o is loaded into memory, the offsets of sections and
symbols remain the same as in the ELF file. Once the memory address of
the file is known, the addresses of sections and symbols can be
calculated by adding their ELF offsets.</p>
<p>In memory, math.o is loaded at address 0x7ffff7ffa000. So, within
math.o:</p>
<ul>
<li>.text locates at 0x7ffff7ffa040 (math.o base address + 0x40).</li>
<li>.data locates at 0x7ffff7ffa070 (math.o base address + 0x70).</li>
</ul>
</div><div class="column" style="width:40%;">
<p>Illustrate memory.</p>
<div class="sourceCode" id="cb44"><pre
class="sourceCode go"><code class="sourceCode go"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="op">+---------------------+</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a><span class="op">|</span> Other Regions<span class="op">...</span>    <span class="op">|</span></span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a><span class="op">+---------------------+</span></span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a><span class="op">|</span> math<span class="op">.</span>o              <span class="op">|</span> <span class="bn">0x7ffff7ffa000</span></span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a><span class="op">|</span>                     <span class="op">|</span></span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a><span class="op">|</span>   <span class="op">.</span>text             <span class="op">|</span> <span class="bn">0x7ffff7ffa040</span></span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a><span class="op">|</span>   ├── sum<span class="op">()</span>         <span class="op">|</span>         <span class="op">+</span> <span class="bn">0x00</span></span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a><span class="op">|</span>   └── sub<span class="op">()</span>         <span class="op">|</span>         <span class="op">+</span> <span class="bn">0x18</span></span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a><span class="op">|</span>                     <span class="op">|</span></span>
<span id="cb44-10"><a href="#cb44-10" aria-hidden="true" tabindex="-1"></a><span class="op">|</span>   <span class="op">.</span>data             <span class="op">|</span> <span class="bn">0x7ffff7ffa070</span></span>
<span id="cb44-11"><a href="#cb44-11" aria-hidden="true" tabindex="-1"></a><span class="op">|</span>   ├── number1       <span class="op">|</span>         <span class="op">+</span> <span class="bn">0x00</span></span>
<span id="cb44-12"><a href="#cb44-12" aria-hidden="true" tabindex="-1"></a><span class="op">|</span>   └── number2       <span class="op">|</span>         <span class="op">+</span> <span class="bn">0x40</span></span>
<span id="cb44-13"><a href="#cb44-13" aria-hidden="true" tabindex="-1"></a><span class="op">+---------------------+</span></span>
<span id="cb44-14"><a href="#cb44-14" aria-hidden="true" tabindex="-1"></a><span class="op">|</span> Other Regions<span class="op">...</span>    <span class="op">|</span></span>
<span id="cb44-15"><a href="#cb44-15" aria-hidden="true" tabindex="-1"></a><span class="op">+---------------------+</span></span></code></pre></div>
</div>
</div>
<p>We need to add symbols in .text and .data of math.o, so we provide
memory address of these sections to GDB.</p>
<div class="sourceCode" id="cb45"><pre
class="sourceCode sh"><code class="sourceCode bash"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="kw">(</span><span class="fu">gdb</span><span class="kw">)</span> <span class="ex">add-symbol-file</span> math.o 0x7ffff7ffa040 <span class="at">-s</span> .data 0x7ffff7ffa070</span></code></pre></div>
<p>Check the loaded files and sections.</p>
<div class="sourceCode" id="cb46"><pre
class="sourceCode sh"><code class="sourceCode bash"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="kw">(</span><span class="fu">gdb</span><span class="kw">)</span> <span class="ex">info</span> files</span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a><span class="ex">0x00007ffff7ffa040</span> <span class="at">-</span> 0x00007ffff7ffa06e is .text in /root/demo/math.o</span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a><span class="ex">0x00007ffff7ffa070</span> <span class="at">-</span> 0x00007ffff7ffa078 is .data in /root/demo/math.o</span></code></pre></div>
<div class="columns">
<div class="column" style="width:50%;">
<p>Check the symbol addresses.</p>
<div class="sourceCode" id="cb47"><pre
class="sourceCode sh"><code class="sourceCode bash"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="kw">(</span><span class="fu">gdb</span><span class="kw">)</span> <span class="ex">info</span> function sum</span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a><span class="ex">0x00007ffff7ffa040</span>  sum</span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a><span class="kw">(</span><span class="fu">gdb</span><span class="kw">)</span> <span class="ex">info</span> function sub</span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a><span class="ex">0x00007ffff7ffa058</span>  sub</span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a><span class="kw">(</span><span class="fu">gdb</span><span class="kw">)</span> <span class="ex">info</span> variable number1</span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a><span class="ex">0x00007ffff7ffa070</span>  number1</span>
<span id="cb47-9"><a href="#cb47-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-10"><a href="#cb47-10" aria-hidden="true" tabindex="-1"></a><span class="kw">(</span><span class="fu">gdb</span><span class="kw">)</span> <span class="ex">info</span> variable number2</span>
<span id="cb47-11"><a href="#cb47-11" aria-hidden="true" tabindex="-1"></a><span class="ex">0x00007ffff7ffa074</span>  number2</span></code></pre></div>
</div><div class="column" style="width:50%;">
<p>After loaded symbols, we can print and call them through symbol
names.</p>
<div class="sourceCode" id="cb48"><pre
class="sourceCode sh"><code class="sourceCode bash"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="kw">(</span><span class="fu">gdb</span><span class="kw">)</span> <span class="ex">call</span> <span class="er">(</span><span class="ex">int</span><span class="kw">)</span> <span class="fu">sum</span><span class="er">(</span><span class="ex">4,</span> 5<span class="kw">)</span></span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a><span class="va">$3</span> = 9</span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a><span class="kw">(</span><span class="fu">gdb</span><span class="kw">)</span> <span class="ex">call</span> <span class="er">(</span><span class="ex">int</span><span class="kw">)</span> <span class="ex">sub</span><span class="er">(</span><span class="ex">4,</span> 5<span class="kw">)</span></span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a><span class="va">$5</span> = <span class="at">-1</span></span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a><span class="kw">(</span><span class="fu">gdb</span><span class="kw">)</span> <span class="ex">print/x</span> <span class="er">(</span><span class="ex">int</span><span class="kw">)</span><span class="ex">number1</span></span>
<span id="cb48-8"><a href="#cb48-8" aria-hidden="true" tabindex="-1"></a><span class="va">$1</span> = 0xcafebabe</span>
<span id="cb48-9"><a href="#cb48-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-10"><a href="#cb48-10" aria-hidden="true" tabindex="-1"></a><span class="kw">(</span><span class="fu">gdb</span><span class="kw">)</span> <span class="ex">print/x</span> <span class="er">(</span><span class="ex">int</span><span class="kw">)</span><span class="ex">number2</span></span>
<span id="cb48-11"><a href="#cb48-11" aria-hidden="true" tabindex="-1"></a><span class="va">$2</span> = 0xc1a0c1a0</span></code></pre></div>
</div>
</div>
<h1 id="references">References</h1>
<ul>
<li><a href="https://man7.org/linux/man-pages/man5/elf.5.html">ELF
Manual</a></li>
</ul>
<footer class="footer text-muted">
   <div align="center">
      <a href="/index.html"><b>Home</b></a>
   </div>
 </footer>
</body>
</html>
