#! /usr/bin/bash

# ====  functions
generate_post() {
    local input="$1"
    local output="$(perl -pe 's{/md/}{/html/}; s{\.md$}{.html}' <<< $input)"
    local topdir="$(perl -pe 's{/md/.*$}{}' <<< $input)"

    pandoc --from markdown --to html \
        --css /html/style/dark.css \
        --include-in-header ${topdir}/bin/header.html \
        --include-after-body ${topdir}/bin/footer.html \
        --highlight-style zenburn \
        --table-of-contents \
        --standalone \
        --mathml \
        --number-sections \
        --output=${output} \
        ${input}
}

generate_post_notoc() {
    local input="$1"
    local output="$(perl -pe 's{/md/}{/html/}; s{\.md$}{.html}' <<< $input)"
    local topdir="$(perl -pe 's{/md/.*$}{}' <<< $input)"

    pandoc --from markdown --to html \
        --css /html/style/dark.css \
        --include-in-header ${topdir}/bin/header.html \
        --include-after-body ${topdir}/bin/footer.html \
        --highlight-style zenburn \
        --standalone \
        --mathml \
        --output=${output} \
        ${input}
}

export -f generate_post
export -f generate_post_notoc

workspace=$(git rev-parse --show-toplevel)

# ====  index
pandoc --from markdown --to html \
    --css /html/style/dark.css \
    --include-in-header ${workspace}/bin/header.html \
    --include-after-body ${workspace}/bin/footer_for_home.html \
    --standalone \
    --output ${workspace}/index.html \
    ${workspace}/md/index.md

# ====  about
pandoc --from markdown --to html \
    --css /html/style/dark.css \
    --include-in-header ${workspace}/bin/header.html \
    --include-after-body ${workspace}/bin/footer.html \
    --standalone \
    --output ${workspace}/html/about.html \
    ${workspace}/md/about.md

# ====  posts
cd ${workspace}

{
    git diff --name-only -- md/
    git ls-files --others --exclude-standard -- md/
} | sort -u | while IFS= read -r file; do
    echo $file
    
    if [[ "$file" == */ref/* ]]; then
        generate_post_notoc "$(readlink -f "$file")"
    else
        generate_post "$(readlink -f "$file")"
    fi
    
done

# find "${workspace}/md/ref" -name "*.md" -exec bash -c 'generate_post_notoc $1' _ {} \;